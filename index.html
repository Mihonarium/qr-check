<!DOCTYPE html>
<html>
  <head>
    <title>Проверка подлинности QR-кодов</title>
    <script src="https://github.com/mebjas/html5-qrcode/releases/download/V2.0.11/html5-qrcode.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
  <div id="instructions" style="width: 90%;margin: auto; position: relative;font-size:40px;"><h2>Как использовать:</h2>
    <ul><li>Разрешите доступ к камере.</li><li>Наведите на QR-код.</li><li>Нажмите на кнопку, чтобы открыть сертификат.</li><li>Сверьте данные с паспортом посетителя.</li></ul>
	<button class="button button--outline button--success" onclick="start()" style="transform: scale(5);transform-origin: 0% 0% 0px;">Начать</button>
	</div>
    <div style="width: 100%; text-align: center; margin: auto;" id="reader"></div>
	<button class="button button--success" style="position:absolute;left:10%;right:10%;top:30%;bottom:30%;margin:auto;font-size:50px;display:none;" id="button">Открыть сертификат</button>
    <script type="text/javascript">
	const allowedHosts = ["www.gosuslugi.ru", "immune.mos.ru"];
	function checkHost(host) {
		for (allowedHost of allowedHosts) {
		  if(host == allowedHost) return true;
		  /*if (host.endsWith("."+allowedHost)) {
			return true;
		  }*/
		}
		return false;
	}
	backgroundIntact = true;
	function resetBackground() {
		backgroundIntact = true;
		$('body').css('background', 'transparent');
	}
	function showSomeColor(color) {
		backgroundIntact = false;
		$('body').css('background', color);
		setTimeout(resetBackground, 1000);
	}
	function openUrl(href) {
		let a = document.createElement("a");
		document.body.appendChild(a);
		a.style = "display: none";
		a.href = href;
		a.target = "_blank";
		a.click();
		document.body.removeChild(a);
	}
	var href = "";
	function onGoodQR(url) {
		showSomeColor('#fff');
		if(url.protocol != "https:") url.protocol = "https:";
		$("#reader").hide();
		$("#button").attr('onclick', 'openCertificate()');
		$("#button").show();
		href = url.href;
	}
	function openCertificate() {
		window.open(href, "_blank");
		$("#button").hide();
		$("#reader").show();
	}
	function onBadQR(url, isStr = false) {
		showSomeColor('#f00');
		if(isStr) {
			alert("QR-код поддельный: содержит текст, а не ссылку");
			return;
		}
		alert("QR-код поддельный: ведёт на "+url.host);
	}
	function onScanSuccess(decodedText, decodedResult) {
		if(!backgroundIntact) return;
		try {
			url = new URL(decodedText);
		} catch (_) {
			onBadQR(decodedText, true);
			return;
		}
		if(!checkHost(url.host)) {
			onBadQR(url);
			return;
		}
		onGoodQR(url);
	}
	function start() {
		$("#instructions").hide();
		const html5QrCode = new Html5Qrcode("reader");
		html5QrCode.start({ facingMode: "environment" }, {
				fps: 10,
				qrbox: Math.min(getWidth(), getHeight()) * 0.9
			  }, onScanSuccess);
	}
	function getWidth() {
	  return Math.max(
		document.body.scrollWidth,
		document.documentElement.scrollWidth,
		document.body.offsetWidth,
		document.documentElement.offsetWidth,
		document.documentElement.clientWidth
	  );
	}

	function getHeight() {
	  return Math.max(
		document.body.scrollHeight,
		document.documentElement.scrollHeight,
		document.body.offsetHeight,
		document.documentElement.offsetHeight,
		document.documentElement.clientHeight
	  );
	}
    </script>
  </body>
</html>
